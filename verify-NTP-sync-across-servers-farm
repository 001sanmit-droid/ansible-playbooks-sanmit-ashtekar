# Title: System Health Audit for KVM VMs
# Author: Er. Sanmit Ashtekar | AWS --> EC2 S3 VPC IAM SG EKS| IAC-Terraform | CT-Ansible | VMware-ESXi 6.7+| DOCKER | K8S | Linux | Windows | python | shell | Flask | Sqlite | Bootstrap5 | Jinja2.0
# Description: This playbookverify NTP sync across all KVM-based virtual machines pool.

---
- name: Verify NTP sync status on KVM VMs
  hosts: all
  become: true
  tasks:

    - name: Check if chronyd service is active
      systemd:
        name: chronyd
        state: started
      register: chronyd_status
      failed_when: chronyd_status.status.ActiveState != "active"

    - name: Run chronyc sources to verify sync
      command: chronyc sources
      register: chronyc_output
      changed_when: false

    - name: Display NTP source status
      debug:
        var: chronyc_output.stdout_lines

    - name: Check system time drift
      command: timedatectl status
      register: timedatectl_output
      changed_when: false

    - name: Display system time status
      debug:
        var: timedatectl_output.stdout_lines
